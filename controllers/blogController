const Blogs=require("../models/blogs");
const base64=require('base-64');

const home=async(req,res)=>{
    const perPage=5;
    const page=req.query.page || 1
    const sort=req.query.sort || 'title'
    try{
    const blogs=await Blogs.find()
    .sort({[sort]:1})
    .skip((perPage*page)-perPage)
    .limit(perPage);

    const count=await Blogs.countDocuments();
    const totalPages=Math.ceil(count/perPage);

    res.render('home',{message:null,blogData:blogs,current:page, pages:totalPages,sort})
    }
    catch(error){
        res.render('home',{message:null,blogData:null,current: 1,pages: 1})
    }

}
const myBlogs=async(req,res)=>{
    const{message}=req.query
    const userId=req.session.userId;
    const myBlogs=await Blogs.find({userId})

    res.render('myblogs',{message: message?base64.decode(message):null,blogData:myBlogs})

}

const addBlog=(req,res)=>{
    res.render('addblog',{message:null})

}

const createBlog=(req,res)=>{
    try{
    const{title,body}=req.body;
    const newBlog=new Blogs({title,body,userId:req.session.userId})
    newBlog.save()
    .then(res=>{
        res.redirect('/myblogs')
    })
    .catch(err=>
        res.render('addblog',{message:"Blog cant be saved at this moment. Please try again later."})
    )
    }

    catch(err){
         res.render('addblog',{message:"Cannot create a blog due to server error. Please try again"})
    }
}

const updateBlog=(req,res)=>{
    try{
    const {blogId}=req.query;
    Blogs.findByIdAndUpdate({_id:blogId},req.body)
    .then(response=>{
        res.redirect('/myblogs')
    })
    .catch(err=>{
        res.render('editblog',{message:"Cannot edit blog. Please try again"})
    })
}
catch(error){
    res.render('editblog',{message:"Cannot edit a blog due to server error. Please try later"})
}
}

const deleteBlog=(req,res)=>{
    try{
    const{blogId}=req.query;
    Blogs.findOneAndDelete({_id:blogId})
    .then(response=>{
        res.redirect('/myblogs')
    })
    .catch(err=>{
        const error=base64.encode("Blog cannot be deleted. Please try again later")

        res.redirect(`/myblogs?message=${error}`)
    })
    }
    catch(err){
      const error=base64.encode("Blog cannot be deleted. Please try again later")

        res.redirect(`/myblogs?message=${error}`)
    }


}
const editBlog=async(req,res)=>{
    try{
        const{blogId}=req.query;
        const blogData=await Blogs.findOne({_id:blogId})
        res.render('editblog',{message:null,blogData})


    }
    catch(err){
        const error=base64.encode("Blog cannot be edited. Please try again later")

        res.redirect(`/myblogs?message=${error}`)

    }

}


module.exports= {home,myBlogs,addBlog,createBlog,deleteBlog,editBlog,updateBlog}
